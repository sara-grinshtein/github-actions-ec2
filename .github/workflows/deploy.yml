name: Deploy Node app to EC2

# Trigger: run this workflow whenever there is a push to the main branch
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    # The environment where the job will run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy over SSH
        # Connect to the EC2 instance using secrets
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_KEY:  ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          # Save the EC2 private key into a file
          echo "$EC2_KEY" > ec2-key.pem
          chmod 600 ec2-key.pem

          # Connect to the EC2 instance and run deployment commands
          ssh -o StrictHostKeyChecking=no -i ec2-key.pem ${EC2_USER}@${EC2_HOST} '
            set -e

            # Install Node.js using nvm if not already installed
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nvm install --lts
            fi

            # Install PM2 if not already installed
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            # Clone or update the repository
            REPO_DIR="$HOME/github-actions-ec2"
            if [ -d "$REPO_DIR/.git" ]; then
              cd "$REPO_DIR"
              git pull origin main
            else
              git clone https://github.com/sara-grinshtein/github-actions-ec2.git "$REPO_DIR"
              cd "$REPO_DIR"
