name: Deploy Node app to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy over SSH
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_KEY:  ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          echo "$EC2_KEY" > ec2-key.pem
          chmod 600 ec2-key.pem

          ssh -o StrictHostKeyChecking=no -i ec2-key.pem ${EC2_USER}@${EC2_HOST} '
            set -e

            # התקנת Node (באמצעות nvm אם צריך)
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nvm install --lts
            fi

            # התקנת PM2 אם צריך
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            # קלון / עדכון הריפו
            REPO_DIR="$HOME/github-actions-ec2"
            if [ -d "$REPO_DIR/.git" ]; then
              cd "$REPO_DIR"
              git pull origin main
            else
              git clone https://github.com/sara-grinshtein/github-actions-ec2.git "$REPO_DIR"
              cd "$REPO_DIR"
            fi

            cd simple-web-server
            npm install

            echo "Starting / restarting app with PM2..."
            pm2 restart server.js || pm2 start server.js
          '
